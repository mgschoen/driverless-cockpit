<link rel="import" href="./fsd-map-imports.html">

<link rel="import" href="fsd-map-converter.html">

<dom-module id="fsd-map">
  <template>
    <style>

      :host {
        display: block;
        height: 500px;
      }

    </style>

    <div id="canvas"></div>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class fsdMap extends Polymer.Element {
      static get is() {
        return 'fsd-map';
      }

      static get properties() {
        return {
          // Program logic internals
          componentReady: { type: Boolean, value: false },
          converter: { type: Object },

          // raw vehicle data
          steerAngle: { type: Number, value: 0.0 },
          pathMiddleX: { type: Number, value: 0.0 },
          pathMiddleY: { type: Number, value: 0.0 },
          vehicleX: { type: Number, value: 0.0 },
          vehicleY: { type: Number, value: 0.0 },

          // transformed vehicle data
          __pathMiddleX: { type: Number, computed: '_transformMeter(pathMiddleX)' },
          __pathMiddleY: { type: Number, computed: '_transformMeter(pathMiddleY)' },
          __vehicleX: { type: Number, computed: '_transformMeter(vehicleX)' },
          __vehicleY: { type: Number, computed: '_transformMeter(vehicleY)' },

          // render objects
          twoApp: { type: Object },
          zui: { type: Object },
          shapeVehicle: { type: Object },
          shapeTrack: { type: Object },
          shapeMiddlePath: { type: Object },

          // view controls
          dragActive: { type: Boolean, value: false },
          __dragListenerFunction: { type: Object },
          showVehicle: { type: Boolean },
          showTrack: { type: Boolean },
          showMiddlePath: { type: Boolean },
          focusVehicle: { type: Boolean }
        };
      }

      static get observers() {
        return [
          '_showParametersChanged(showVehicle, showTrack, showMiddlePath)'
        ];
      }

      ready() {
        super.ready();

        // Initialise converter component
        this.converter = new fsdMapConverter();

        // Initialise Two.js app
        var canvas = this.shadowRoot.querySelector('#canvas');
        this.twoApp = new Two({
          width: this.offsetWidth,
          height: 500
        }).appendTo(canvas);

        // draw middle path
        let anchor = new Two.Anchor(0, 0);
        this.shapeMiddlePath = this.twoApp.makePath([anchor], true);
        this.shapeMiddlePath.noFill();
        this.shapeMiddlePath.stroke = '#323232';
        this.shapeMiddlePath.linewidth = 60;

        // draw vehicle track
        this.shapeTrack = this.twoApp.makePath([anchor], true);
        this.shapeTrack.noFill();
        this.shapeTrack.stroke = '#ffffff';
        this.shapeTrack.linewidth = 4;

        // draw vehicle
        this.shapeVehicle = this.twoApp.makeCircle(0, 0, 4);
        this.shapeVehicle.fill = '#ff0000';

        // add zoomable UI
        this.zui = new ZUI(this.twoApp);
        this.zui.addLimits(0.06, 8);
        this.twoApp.renderer.domElement.addEventListener('mousewheel', this._performZoom.bind(this));
        this.twoApp.renderer.domElement.addEventListener('wheel', this._performZoom.bind(this));

        // add drag listeners
        this.twoApp.renderer.domElement.addEventListener('mousedown', this._startDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseup', this._stopDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseleave', this._stopDrag.bind(this));
        this.__dragListenerFunction = this._dragStep.bind(this);

        // start animation loop
        this.twoApp.play();
      }

      updateView () {

        // move vehicle
        if (this.shapeVehicle) {
          this.shapeVehicle.translation.x = this.__vehicleX;
          this.shapeVehicle.translation.y = this.__vehicleY;
        }

        // draw vehicle track
        if (this.shapeTrack) {
          let anchor = new Two.Anchor(this.__vehicleX, this.__vehicleY);
          this.shapeTrack.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeTrack.vertices.length === 2) {
            var firstVertex = this.shapeTrack.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeTrack.vertices.shift();
            }
          }
        }

        // draw middle path
        if (this.shapeMiddlePath) {
          let anchor = new Two.Anchor(this.__pathMiddleX, this.__pathMiddleY);
          this.shapeMiddlePath.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeMiddlePath.vertices.length === 2) {
            var firstVertex = this.shapeMiddlePath.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeMiddlePath.vertices.shift();
            }
          }
        }

        // if vehicle focus on, move camera
        if (this.focusVehicle) {
          let scale = this.zui.scale;
          let canvas = new Two.Vector(this.twoApp.width, this.twoApp.height);
          let absoluteCarpos = this.shapeVehicle.translation;
          let onscreenCarpos = new Two.Vector(absoluteCarpos.x * scale, absoluteCarpos.y * scale);
          let camTranslation = this.zui.surfaces[0].object.translation;
          let onscreenCampos = new Two.Vector(-camTranslation.x, -camTranslation.y);
          let onscreenCamFocus = new Two.Vector(onscreenCampos.x + canvas.x/2,
                                                onscreenCampos.y + canvas.y/2);
          let onscreenDist = new Two.Vector(onscreenCarpos.x - onscreenCamFocus.x,
                                            onscreenCarpos.y - onscreenCamFocus.y);
          this.zui.translateSurface(-onscreenDist.x, -onscreenDist.y);
          this.zui.updateSurface();
        }
      }

      _performZoom (e) {
        e.stopPropagation();
        e.preventDefault();

        var dy = (e.wheelDeltaY || -e.deltaY) / 1000;

        this.zui.zoomBy(dy, e.clientX, e.clientY);
      }

      _startDrag (e) {
        if (!this.dragActive) {
          this.dragActive = true;
          this.twoApp.renderer.domElement.addEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _stopDrag (e) {
        if (this.dragActive) {
          this.dragActive = false;
          this.twoApp.renderer.domElement.removeEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _dragStep (e) {
        this.zui.translateSurface(e.movementX, e.movementY);
        this.zui.updateSurface();
      }

      _showParametersChanged (showVehicle, showTrack, showMiddlePath) {
        if (this.shapeVehicle) {
          this.shapeVehicle.opacity = (showVehicle) ? 1 : 0;
        }
        if (this.shapeTrack) {
          this.shapeTrack.opacity = (showTrack) ? 1 : 0;
        }
        if (this.shapeMiddlePath) {
          this.shapeMiddlePath.opacity = (showMiddlePath) ? 1 : 0;
        }
      }

      _transformMeter (m) {
        return (this.converter) ? this.converter.meterToPixels(m) : 0.0;
      }
    }

    window.customElements.define(fsdMap.is, fsdMap);
  </script>
</dom-module>
