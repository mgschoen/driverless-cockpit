<link rel="import" href="./fsd-map-imports.html">

<link rel="import" href="fsd-map-converter.html">

<dom-module id="fsd-map">
  <template>
    <style>

      :host {
        display: block;
        height: 500px;
      }

      #svgCloak {
        display: none;
      }

    </style>

    <div id="svgCloak">
      <svg xmlns="http://www.w3.org/2000/svg" id="svgCar"><path id="outline" fill="white" stroke="black" stroke-width="2" d="M 186.60,24.69 C 184.34,22.00 184.12,6.08 186.60,3.60 188.23,1.96 190.86,2.04 193.00,2.00 193.00,2.00 224.00,2.00 224.00,2.00 225.95,2.04 228.63,1.90 229.98,3.60 231.15,5.08 230.99,8.18 231.00,10.00 231.02,13.13 231.51,22.39 229.98,24.69 227.70,28.10 217.86,27.00 214.00,27.00 215.17,31.35 220.47,44.68 223.61,47.40 225.50,49.04 228.58,49.16 231.00,49.95 237.51,52.07 248.21,54.03 255.00,53.00 255.00,53.00 251.00,52.00 251.00,52.00 251.00,52.00 251.00,3.00 251.00,3.00 251.00,3.00 297.00,3.00 297.00,3.00 297.00,3.00 297.00,145.00 297.00,145.00 297.00,145.00 251.00,145.00 251.00,145.00 251.00,145.00 251.00,96.00 251.00,96.00 251.00,96.00 254.00,97.00 254.00,97.00 250.01,94.11 245.68,95.73 241.00,96.42 237.49,96.94 225.95,99.57 223.53,101.60 221.13,103.60 215.53,116.45 214.00,120.00 226.66,123.08 230.92,116.95 231.00,129.00 231.00,129.00 231.00,138.00 231.00,138.00 230.95,140.55 231.07,143.23 228.69,144.83 226.90,146.01 224.07,145.97 222.00,146.00 222.00,146.00 196.00,146.00 196.00,146.00 193.23,145.99 189.56,146.29 187.31,144.40 184.10,141.69 184.93,133.03 185.00,129.00 185.03,127.55 185.02,125.48 185.60,124.15 188.25,118.06 198.01,123.62 200.94,118.69 202.38,116.24 200.57,112.41 199.68,110.00 198.75,107.46 197.35,103.44 195.38,101.49 192.20,98.60 182.82,100.18 179.00,101.49 170.48,104.10 169.03,114.72 163.79,119.77 160.09,123.35 156.73,122.99 152.00,123.00 152.00,123.00 152.00,130.00 152.00,130.00 151.92,141.10 145.08,140.17 136.00,141.28 120.41,143.20 103.04,141.59 90.00,132.07 80.96,125.48 75.79,116.97 69.00,112.00 69.25,119.84 70.90,118.64 71.89,124.00 71.89,124.00 71.89,137.00 71.89,137.00 71.95,139.55 72.07,142.23 69.69,143.83 67.73,145.13 64.29,144.99 62.00,145.00 62.00,145.00 35.00,145.00 35.00,145.00 32.63,144.96 29.42,145.04 27.60,143.26 25.66,141.36 26.01,137.53 26.00,135.00 25.99,129.32 25.64,124.59 27.00,119.00 27.00,119.00 9.00,119.00 9.00,119.00 9.00,119.00 9.00,61.00 9.00,61.00 9.00,61.00 8.00,30.00 8.00,30.00 8.00,30.00 41.00,28.00 41.00,28.00 37.74,28.00 29.89,28.69 27.60,26.40 25.23,24.04 25.94,13.55 26.00,10.00 26.03,8.41 25.93,6.05 26.99,4.74 28.70,2.62 33.50,3.00 36.00,3.00 36.00,3.00 63.00,3.00 63.00,3.00 65.35,3.02 68.61,2.81 70.40,4.60 72.68,6.87 72.80,22.92 70.98,25.57 69.14,28.25 63.29,28.06 60.00,29.00 66.91,29.03 68.74,28.50 69.00,36.00 75.14,32.95 80.22,23.81 90.00,16.51 103.59,6.37 117.03,6.82 133.00,7.00 137.16,7.05 147.59,8.38 150.40,11.51 152.74,14.12 152.00,22.43 152.00,26.00 154.99,26.00 159.20,25.70 161.83,27.17 167.90,30.58 168.83,40.18 176.02,45.57 180.68,49.06 190.28,49.00 196.00,49.00 198.08,40.19 201.75,38.25 202.00,27.00 197.90,27.00 189.36,27.97 186.60,24.69 Z M 203.00,33.00 C 203.00,33.00 204.00,43.00 204.00,43.00 204.00,43.00 205.00,33.00 205.00,33.00 205.00,33.00 203.00,33.00 203.00,33.00 Z M 218.85,47.40 C 219.81,45.77 218.54,43.47 217.80,42.00 215.18,36.75 214.09,33.48 208.00,33.00 207.91,37.07 205.78,43.10 209.00,46.00 209.00,46.00 208.00,48.00 208.00,48.00 210.44,48.69 217.19,50.19 218.85,47.40 Z M 200.00,41.00 C 199.37,44.78 198.71,45.75 201.00,49.00 201.00,49.00 202.00,41.00 202.00,41.00 202.00,41.00 200.00,41.00 200.00,41.00 Z M 200.00,100.00 C 199.12,103.73 198.80,105.51 202.00,108.00 202.00,108.00 202.00,100.00 202.00,100.00 202.00,100.00 200.00,100.00 200.00,100.00 Z M 208.00,100.00 C 208.00,100.00 207.20,106.01 207.20,106.01 207.20,106.01 208.00,116.00 208.00,116.00 214.73,114.85 218.23,107.05 220.00,101.00 220.00,101.00 208.00,100.00 208.00,100.00 Z M 203.00,115.00 C 203.00,115.00 205.00,115.00 205.00,115.00 205.00,115.00 204.00,105.00 204.00,105.00 204.00,105.00 203.00,115.00 203.00,115.00 Z" /><path id="detail"  fill="none" stroke="black" stroke-width="1"  d="M 121.00,46.59 C 117.72,46.08 106.67,44.72 104.02,45.74 98.72,47.79 99.01,52.26 99.00,57.00 99.00,57.00 99.00,93.00 99.00,93.00 99.09,99.35 99.89,102.69 107.00,102.98 114.70,103.30 123.19,100.95 131.00,100.17 131.00,100.17 158.00,96.00 158.00,96.00 158.00,96.00 133.00,97.00 133.00,97.00 133.00,97.00 138.00,98.00 138.00,98.00 138.00,98.00 122.00,99.00 122.00,99.00 122.00,99.00 132.01,95.26 132.01,95.26 132.01,95.26 133.00,83.00 133.00,83.00 133.00,83.00 133.00,52.00 133.00,52.00 133.00,52.00 122.00,52.00 122.00,52.00 122.00,52.00 125.00,49.00 125.00,49.00 127.48,51.54 129.43,50.20 132.72,50.87 138.91,52.15 151.18,54.31 157.00,52.00 157.00,52.00 121.00,46.59 121.00,46.59 Z M 95.00,58.00 C 95.00,58.00 95.00,51.00 95.00,51.00 92.74,53.82 93.14,55.04 95.00,58.00 Z M 206.00,55.00 C 206.00,55.00 206.00,61.00 206.00,61.00 206.00,61.00 208.00,61.00 208.00,61.00 208.00,61.00 208.00,55.00 208.00,55.00 208.00,55.00 206.00,55.00 206.00,55.00 Z M 165.43,64.02 C 163.43,57.44 156.43,58.22 154.20,62.15 152.57,65.01 152.76,80.37 153.42,83.98 154.69,90.90 161.44,90.86 164.15,87.57 166.37,84.85 166.00,79.38 166.00,76.00 166.00,76.00 173.00,77.00 173.00,77.00 173.00,77.00 174.00,83.00 174.00,83.00 174.32,76.01 176.00,72.01 173.00,65.00 173.00,65.00 173.00,72.00 173.00,72.00 173.00,72.00 167.00,73.00 167.00,73.00 167.00,73.00 165.43,64.02 165.43,64.02 Z M 80.00,67.00 C 80.00,67.00 80.00,62.00 80.00,62.00 78.34,64.53 78.34,64.47 80.00,67.00 Z M 83.00,64.00 C 83.00,64.00 82.08,74.00 82.08,74.00 82.08,74.00 83.00,85.00 83.00,85.00 83.00,85.00 86.00,85.00 86.00,85.00 86.00,85.00 86.00,64.00 86.00,64.00 86.00,64.00 83.00,64.00 83.00,64.00 Z M 206.00,88.00 C 206.00,88.00 205.00,94.00 205.00,94.00 205.00,94.00 207.00,94.00 207.00,94.00 207.00,94.00 209.00,89.00 209.00,89.00 209.00,89.00 208.00,88.00 208.00,88.00 208.00,88.00 206.00,88.00 206.00,88.00 Z M 95.00,98.00 C 95.00,98.00 95.00,91.00 95.00,91.00 93.08,93.99 92.88,95.08 95.00,98.00 Z" /></svg>
    </div>

    <div id="canvas"></div>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class fsdMap extends Polymer.Element {
      static get is() {
        return 'fsd-map';
      }

      static get properties() {
        return {
          // Program logic internals
          componentReady: { type: Boolean, value: false },
          converter: { type: Object },

          // raw vehicle data
          steerAngle: { type: Number, value: 0.0 },
          pathMiddleX: { type: Number, value: 0.0 },
          pathMiddleY: { type: Number, value: 0.0 },
          vehicleX: { type: Number, value: 0.0 },
          vehicleY: { type: Number, value: 0.0 },

          // transformed vehicle data
          __pathMiddleX: { type: Number, computed: '_transformMeter(pathMiddleX)' },
          __pathMiddleY: { type: Number, computed: '_transformMeter(pathMiddleY)' },
          __vehicleX: { type: Number, computed: '_transformMeter(vehicleX)' },
          __vehicleY: { type: Number, computed: '_transformMeter(vehicleY)' },

          // render objects
          twoApp: { type: Object },
          zui: { type: Object },
          shapeVehicle: { type: Object },
          shapeTrack: { type: Object },
          shapeMiddlePath: { type: Object },

          // view controls
          dragActive: { type: Boolean, value: false },
          __dragListenerFunction: { type: Object },
          showVehicle: { type: Boolean },
          showTrack: { type: Boolean },
          showMiddlePath: { type: Boolean },
          focusVehicle: { type: Boolean }
        };
      }

      static get observers() {
        return [
          '_showParametersChanged(showVehicle, showTrack, showMiddlePath)'
        ];
      }

      ready() {
        super.ready();

        // Initialise converter component
        this.converter = new fsdMapConverter();

        // Initialise Two.js app
        var canvas = this.shadowRoot.querySelector('#canvas');
        this.twoApp = new Two({
          width: this.offsetWidth,
          height: 500
        }).appendTo(canvas);

        // draw middle path
        let anchor = new Two.Anchor(0, 0);
        this.shapeMiddlePath = this.twoApp.makePath([anchor], true);
        this.shapeMiddlePath.noFill();
        this.shapeMiddlePath.stroke = '#323232';
        this.shapeMiddlePath.linewidth = this.converter.meterToPixels(3);

        // draw vehicle track
        this.shapeTrack = this.twoApp.makePath([anchor], true);
        this.shapeTrack.noFill();
        this.shapeTrack.stroke = '#ffffff';
        this.shapeTrack.linewidth = 4;

        // draw vehicle
        this.shapeVehicle = this.twoApp.interpret(this.shadowRoot.querySelector('#svgCar')).center();
        this.shapeVehicle.scale = 0.2;
        this.shapeVehicle.opacity = 0.7;

        // add zoomable UI
        this.zui = new ZUI(this.twoApp);
        this.zui.addLimits(0.06, 8);
        this.twoApp.renderer.domElement.addEventListener('mousewheel', this._performZoom.bind(this));
        this.twoApp.renderer.domElement.addEventListener('wheel', this._performZoom.bind(this));

        // add drag listeners
        this.twoApp.renderer.domElement.addEventListener('mousedown', this._startDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseup', this._stopDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseleave', this._stopDrag.bind(this));
        this.__dragListenerFunction = this._dragStep.bind(this);

        // start animation loop
        this.twoApp.play();

        // add resize listener
        window.addEventListener('resize', function () {
          this.twoApp.width = this.offsetWidth;
        }.bind(this));
      }

      updateView () {

        // draw vehicle track
        if (this.shapeTrack) {
          let anchor = new Two.Anchor(this.__vehicleX, this.__vehicleY);
          this.shapeTrack.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeTrack.vertices.length === 2) {
            var firstVertex = this.shapeTrack.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeTrack.vertices.shift();
            }
          }
        }

        // draw middle path
        if (this.shapeMiddlePath) {
          let anchor = new Two.Anchor(this.__pathMiddleX, this.__pathMiddleY);
          this.shapeMiddlePath.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeMiddlePath.vertices.length === 2) {
            var firstVertex = this.shapeMiddlePath.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeMiddlePath.vertices.shift();
            }
          }
        }

        // move vehicle
        if (this.shapeVehicle) {
          this.shapeVehicle.translation.x = this.__vehicleX;
          this.shapeVehicle.translation.y = this.__vehicleY;
        }

        // rotate vehicle
        let numVertices = this.shapeTrack.vertices.length;
        if (numVertices > 2) {
          let next2Last = this.shapeTrack.vertices[numVertices-2];
          let last = this.shapeTrack.vertices[numVertices-1];
          let dir = new Two.Vector(last.x - next2Last.x, last.y - next2Last.y);
          let dirLength = Math.sqrt(Math.pow(dir.x,2) + Math.pow(dir.y,2));
          let cosine = dir.x / dirLength;
          let radiant = Math.acos(cosine);
          this.shapeVehicle.rotation = (dir.y >= 0) ? radiant : (2 * Math.PI - radiant);
        }

        // if vehicle focus on, move camera
        if (this.focusVehicle) {
          let scale = this.zui.scale;
          let canvas = new Two.Vector(this.twoApp.width, this.twoApp.height);
          let absoluteCarpos = this.shapeVehicle.translation;
          let onscreenCarpos = new Two.Vector(absoluteCarpos.x * scale, absoluteCarpos.y * scale);
          let camTranslation = this.zui.surfaces[0].object.translation;
          let onscreenCampos = new Two.Vector(-camTranslation.x, -camTranslation.y);
          let onscreenCamFocus = new Two.Vector(onscreenCampos.x + canvas.x/2,
                                                onscreenCampos.y + canvas.y/2);
          let onscreenDist = new Two.Vector(onscreenCarpos.x - onscreenCamFocus.x,
                                            onscreenCarpos.y - onscreenCamFocus.y);
          this.zui.translateSurface(-onscreenDist.x, -onscreenDist.y);
          this.zui.updateSurface();
        }
      }

      _performZoom (e) {
        e.stopPropagation();
        e.preventDefault();

        var dy = (e.wheelDeltaY || -e.deltaY) / 1000;

        this.zui.zoomBy(dy, e.clientX, e.clientY);
      }

      _startDrag (e) {
        if (!this.dragActive) {
          this.dragActive = true;
          this.twoApp.renderer.domElement.addEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _stopDrag (e) {
        if (this.dragActive) {
          this.dragActive = false;
          this.twoApp.renderer.domElement.removeEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _dragStep (e) {
        this.zui.translateSurface(e.movementX, e.movementY);
        this.zui.updateSurface();
      }

      _showParametersChanged (showVehicle, showTrack, showMiddlePath) {
        if (this.shapeVehicle) {
          this.shapeVehicle.opacity = (showVehicle) ? 1 : 0;
        }
        if (this.shapeTrack) {
          this.shapeTrack.opacity = (showTrack) ? 1 : 0;
        }
        if (this.shapeMiddlePath) {
          this.shapeMiddlePath.opacity = (showMiddlePath) ? 1 : 0;
        }
      }

      _transformMeter (m) {
        return (this.converter) ? this.converter.meterToPixels(m) : 0.0;
      }
    }

    window.customElements.define(fsdMap.is, fsdMap);
  </script>
</dom-module>
