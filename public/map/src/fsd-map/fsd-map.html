<link rel="import" href="./fsd-map-imports.html">

<dom-module id="fsd-map">
  <template>
    <style>

      :host {
        display: block;
        height: 500px;
      }

    </style>

    <div id="canvas"></div>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class fsdMap extends Polymer.Element {
      static get is() {
        return 'fsd-map';
      }

      static get properties() {
        return {
          // Lifecycle check
          componentReady: { type: Boolean, value: false },

          // vehicle data
          steerAngle: { type: Number, value: 0.0 },
          pathMiddleX: { type: Number, value: 0.0 },
          pathMiddleY: { type: Number, value: 0.0 },
          vehicleX: { type: Number, value: 0.0 },
          vehicleY: { type: Number, value: 0.0 },

          // render objects
          twoApp: { type: Object },
          zui: { type: Object },
          shapeVehicle: { type: Object },
          shapeTrack: { type: Object },
          shapeMiddlePath: { type: Object },

          // view controls
          dragActive: { type: Boolean, value: false },
          __dragListenerFunction: { type: Object }
        };
      }

      ready() {
        super.ready();

        // Initialise Two.js app
        var canvas = this.shadowRoot.querySelector('#canvas');
        this.twoApp = new Two({
          width: this.offsetWidth,
          height: 500
        }).appendTo(canvas);

        // draw vehicle
        this.shapeVehicle = this.twoApp.makeCircle(0, 0, 4);
        this.shapeVehicle.fill = '#ff0000';

        // draw vehicle track
        let anchor = new Two.Anchor(0, 0);
        this.shapeTrack = this.twoApp.makePath([anchor], true);
        this.shapeTrack.noFill();

        // draw middle path
        this.shapeMiddlePath = this.twoApp.makePath([anchor], true);
        this.shapeMiddlePath.noFill();
        this.shapeMiddlePath.stroke = '#0000ff';

        // add zoomable UI
        this.zui = new ZUI(this.twoApp);
        this.zui.addLimits(0.06, 8);
        this.twoApp.renderer.domElement.addEventListener('mousewheel', this._performZoom.bind(this));
        this.twoApp.renderer.domElement.addEventListener('wheel', this._performZoom.bind(this));

        // add drag listeners
        this.twoApp.renderer.domElement.addEventListener('mousedown', this._startDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseup', this._stopDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseleave', this._stopDrag.bind(this));
        this.__dragListenerFunction = this._dragStep.bind(this);

        // start animation loop
        this.twoApp.play();
      }

      updateView () {

        // move vehicle
        if (this.shapeVehicle) {
          this.shapeVehicle.translation.x = this.vehicleX;
          this.shapeVehicle.translation.y = this.vehicleY;
        }

        // draw vehicle track
        if (this.shapeTrack) {
          let anchor = new Two.Anchor(this.vehicleX, this.vehicleY);
          this.shapeTrack.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeTrack.vertices.length === 2) {
            var firstVertex = this.shapeTrack.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeTrack.vertices.shift();
            }
          }
        }

        // draw middle path
        if (this.shapeMiddlePath) {
          let anchor = new Two.Anchor(this.pathMiddleX, this.pathMiddleY);
          this.shapeMiddlePath.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeMiddlePath.vertices.length === 2) {
            var firstVertex = this.shapeMiddlePath.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeMiddlePath.vertices.shift();
            }
          }
        }
      }

      _performZoom (e) {
        e.stopPropagation();
        e.preventDefault();

        var dy = (e.wheelDeltaY || -e.deltaY) / 1000;

        this.zui.zoomBy(dy, e.clientX, e.clientY);
      }

      _startDrag (e) {
        if (!this.dragActive) {
          this.dragActive = true;
          this.twoApp.renderer.domElement.addEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _stopDrag (e) {
        if (this.dragActive) {
          this.dragActive = false;
          this.twoApp.renderer.domElement.removeEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _dragStep (e) {
        this.zui.translateSurface(e.movementX, e.movementY);
        this.zui.updateSurface();
      }
    }

    window.customElements.define(fsdMap.is, fsdMap);
  </script>
</dom-module>
