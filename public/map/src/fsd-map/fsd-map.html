<link rel="import" href="./fsd-map-imports.html">

<link rel="import" href="fsd-map-converter.html">

<dom-module id="fsd-map">
  <template>
    <style>

      :host {
        display: block;
        height: 500px;
      }

      #svgCloak {
        display: none;
      }

    </style>

    <div id="svgCloak">
      <svg xmlns="http://www.w3.org/2000/svg" version="1.0" viewBox="0 0 50 50" id="svgCar">
        <path stroke="#000000" stroke-width="0.5" fill="#ffffff" d="M 7 9 C 5.897 9 5 9.897 5 11 L 5 11.4375 C 6.328 12.0205 7.324 13.1585 7.75 14.5625 C 7.917 14.8145 8 15.245 8 16 L 8 18 L 11 18 L 11 19 L 13 19 L 13 18 L 15 18 C 16.103 18 17 17.103 17 16 L 17 11 C 17 9.897 16.103 9 15 9 L 7 9 z M 34 10 C 32.897 10 32 10.897 32 12 L 32 16 C 32 17.103 32.897 18 34 18 L 35 18 L 35 19 L 37 19 L 37 18 L 38 18 L 38 19 L 40 19 L 40 18 L 41 18 C 42.103 18 43 17.103 43 16 L 43 12 C 43 10.897 42.103 10 41 10 L 34 10 z M 1 13 C 0.448 13 0 13.448 0 14 L 0 36 C 0 36.553 0.448 37 1 37 L 3 37 C 4.654 37 6 35.654 6 34 L 6 16 C 6 14.346 4.654 13 3 13 L 1 13 z M 45 13 C 44.447 13 44 13.448 44 14 L 44 18.625 C 47.242 19.242 49.80475 20.10125 49.96875 20.15625 C 49.98475 20.16125 49.985 20.1825 50 20.1875 L 50 14 C 50 13.448 49.553 13 49 13 L 45 13 z M 20 15 C 19.649 15 19.33625 15.199 19.15625 15.5 L 16.4375 20 L 8 20 L 8 30 L 16.4375 30 L 19.15625 34.5 C 19.33625 34.8 19.649 35 20 35 L 27 35 C 27.208 35 27.42475 34.9345 27.59375 34.8125 L 34.3125 30 L 38 30 C 43.05 30 49.0605 28.0215 49.3125 27.9375 C 49.7235 27.8025 50 27.432 50 27 L 50 23 C 50 22.57 49.7205 22.1995 49.3125 22.0625 C 49.0635 21.9785 43.157 20 38 20 L 34.3125 20 L 27.59375 15.1875 C 27.42475 15.0665 27.208 15 27 15 L 20 15 z M 22 22 L 27 22 C 28.657 22 30 23.343 30 25 C 30 26.657 28.657 28 27 28 L 22 28 L 22 22 z M 50 29.8125 C 49.981 29.8195 49.9565 29.83775 49.9375 29.84375 C 49.7705 29.89875 47.219 30.72875 44 31.34375 L 44 36 C 44 36.553 44.447 37 45 37 L 49 37 C 49.553 37 50 36.553 50 36 L 50 29.8125 z M 11 31 L 11 32 L 8 32 L 8 34 C 8 34.496 7.97425 34.809 7.90625 35 C 7.58025 36.61 6.469 37.9185 5 38.5625 L 5 39 C 5 40.105 5.895 41 7 41 L 15 41 C 16.105 41 17 40.105 17 39 L 17 34 C 17 32.895 16.105 32 15 32 L 13 32 L 13 31 L 11 31 z M 35 31 L 35 32 L 34 32 C 32.897 32 32 32.897 32 34 L 32 38 C 32 39.103 32.897 40 34 40 L 41 40 C 42.103 40 43 39.103 43 38 L 43 34 C 43 32.897 42.103 32 41 32 L 40 32 L 40 31 L 38 31 L 38 32 L 37 32 L 37 31 L 35 31 z"/>
      </svg>
    </div>

    <div id="canvas"></div>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class fsdMap extends Polymer.Element {
      static get is() {
        return 'fsd-map';
      }

      static get properties() {
        return {
          // Program logic internals
          componentReady: { type: Boolean, value: false },
          converter: { type: Object },

          // raw vehicle data
          steerAngle: { type: Number, value: 0.0 },
          pathMiddleX: { type: Number, value: 0.0 },
          pathMiddleY: { type: Number, value: 0.0 },
          vehicleX: { type: Number, value: 0.0 },
          vehicleY: { type: Number, value: 0.0 },

          // transformed vehicle data
          __pathMiddleX: { type: Number, computed: '_transformMeter(pathMiddleX)' },
          __pathMiddleY: { type: Number, computed: '_transformMeter(pathMiddleY)' },
          __vehicleX: { type: Number, computed: '_transformMeter(vehicleX)' },
          __vehicleY: { type: Number, computed: '_transformMeter(vehicleY)' },

          // render objects
          twoApp: { type: Object },
          zui: { type: Object },
          shapeVehicle: { type: Object },
          shapeTrack: { type: Object },
          shapeMiddlePath: { type: Object },

          // view controls
          dragActive: { type: Boolean, value: false },
          __dragListenerFunction: { type: Object },
          showVehicle: { type: Boolean },
          showTrack: { type: Boolean },
          showMiddlePath: { type: Boolean },
          focusVehicle: { type: Boolean }
        };
      }

      static get observers() {
        return [
          '_showParametersChanged(showVehicle, showTrack, showMiddlePath)'
        ];
      }

      ready() {
        super.ready();

        // Initialise converter component
        this.converter = new fsdMapConverter();

        // Initialise Two.js app
        var canvas = this.shadowRoot.querySelector('#canvas');
        this.twoApp = new Two({
          width: this.offsetWidth,
          height: 500
        }).appendTo(canvas);

        // draw middle path
        let anchor = new Two.Anchor(0, 0);
        this.shapeMiddlePath = this.twoApp.makePath([anchor], true);
        this.shapeMiddlePath.noFill();
        this.shapeMiddlePath.stroke = '#323232';
        this.shapeMiddlePath.linewidth = 60;

        // draw vehicle track
        this.shapeTrack = this.twoApp.makePath([anchor], true);
        this.shapeTrack.noFill();
        this.shapeTrack.stroke = '#ffffff';
        this.shapeTrack.linewidth = 4;

        // draw vehicle
        this.shapeVehicle = this.twoApp.interpret(this.shadowRoot.querySelector('#svgCar')).center();
        this.shapeVehicle.fill = '#ffffff';
        //this.shapeVehicle.opacity = 0.7;

        // add zoomable UI
        this.zui = new ZUI(this.twoApp);
        this.zui.addLimits(0.06, 8);
        this.twoApp.renderer.domElement.addEventListener('mousewheel', this._performZoom.bind(this));
        this.twoApp.renderer.domElement.addEventListener('wheel', this._performZoom.bind(this));

        // add drag listeners
        this.twoApp.renderer.domElement.addEventListener('mousedown', this._startDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseup', this._stopDrag.bind(this));
        this.twoApp.renderer.domElement.addEventListener('mouseleave', this._stopDrag.bind(this));
        this.__dragListenerFunction = this._dragStep.bind(this);

        // start animation loop
        this.twoApp.play();

        // resize listener
        window.addEventListener('resize', function () {
          this.twoApp.width = this.offsetWidth;
        }.bind(this));
      }

      updateView () {

        // draw vehicle track
        if (this.shapeTrack) {
          let anchor = new Two.Anchor(this.__vehicleX, this.__vehicleY);
          this.shapeTrack.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeTrack.vertices.length === 2) {
            var firstVertex = this.shapeTrack.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeTrack.vertices.shift();
            }
          }
        }

        // draw middle path
        if (this.shapeMiddlePath) {
          let anchor = new Two.Anchor(this.__pathMiddleX, this.__pathMiddleY);
          this.shapeMiddlePath.vertices.push(anchor);

          // when second vertex is added, remove origin
          if (this.shapeMiddlePath.vertices.length === 2) {
            var firstVertex = this.shapeMiddlePath.vertices[0];
            if (firstVertex.x === 0 && firstVertex.y === 0) {
              this.shapeMiddlePath.vertices.shift();
            }
          }
        }

        // move vehicle
        if (this.shapeVehicle) {
          this.shapeVehicle.translation.x = this.__vehicleX;
          this.shapeVehicle.translation.y = this.__vehicleY;
        }

        // rotate vehicle
        let numVertices = this.shapeTrack.vertices.length;
        if (numVertices > 2) {
          let next2Last = this.shapeTrack.vertices[numVertices-2];
          let last = this.shapeTrack.vertices[numVertices-1];
          let dir = new Two.Vector(last.x - next2Last.x, last.y - next2Last.y);
          let dirLength = Math.sqrt(Math.pow(dir.x,2) + Math.pow(dir.y,2));
          let cosine = dir.x / dirLength;
          let radiant = Math.acos(cosine);
          this.shapeVehicle.rotation = (dir.y >= 0) ? radiant : (2 * Math.PI - radiant);
        }

        // if vehicle focus on, move camera
        if (this.focusVehicle) {
          let scale = this.zui.scale;
          let canvas = new Two.Vector(this.twoApp.width, this.twoApp.height);
          let absoluteCarpos = this.shapeVehicle.translation;
          let onscreenCarpos = new Two.Vector(absoluteCarpos.x * scale, absoluteCarpos.y * scale);
          let camTranslation = this.zui.surfaces[0].object.translation;
          let onscreenCampos = new Two.Vector(-camTranslation.x, -camTranslation.y);
          let onscreenCamFocus = new Two.Vector(onscreenCampos.x + canvas.x/2,
                                                onscreenCampos.y + canvas.y/2);
          let onscreenDist = new Two.Vector(onscreenCarpos.x - onscreenCamFocus.x,
                                            onscreenCarpos.y - onscreenCamFocus.y);
          this.zui.translateSurface(-onscreenDist.x, -onscreenDist.y);
          this.zui.updateSurface();
        }
      }

      _performZoom (e) {
        e.stopPropagation();
        e.preventDefault();

        var dy = (e.wheelDeltaY || -e.deltaY) / 1000;

        this.zui.zoomBy(dy, e.clientX, e.clientY);
      }

      _startDrag (e) {
        if (!this.dragActive) {
          this.dragActive = true;
          this.twoApp.renderer.domElement.addEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _stopDrag (e) {
        if (this.dragActive) {
          this.dragActive = false;
          this.twoApp.renderer.domElement.removeEventListener('mousemove', this.__dragListenerFunction);
        }
      }

      _dragStep (e) {
        this.zui.translateSurface(e.movementX, e.movementY);
        this.zui.updateSurface();
      }

      _showParametersChanged (showVehicle, showTrack, showMiddlePath) {
        if (this.shapeVehicle) {
          this.shapeVehicle.opacity = (showVehicle) ? 1 : 0;
        }
        if (this.shapeTrack) {
          this.shapeTrack.opacity = (showTrack) ? 1 : 0;
        }
        if (this.shapeMiddlePath) {
          this.shapeMiddlePath.opacity = (showMiddlePath) ? 1 : 0;
        }
      }

      _transformMeter (m) {
        return (this.converter) ? this.converter.meterToPixels(m) : 0.0;
      }
    }

    window.customElements.define(fsdMap.is, fsdMap);
  </script>
</dom-module>
